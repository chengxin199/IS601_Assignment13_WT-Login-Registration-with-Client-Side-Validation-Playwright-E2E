{% extends "layout.html" %}

{% block title %}Register - Calculations Pro{% endblock %}

{% block content %}
<div class="card" style="max-width: 520px; margin: 0 auto;">
  <div style="text-align: center; margin-bottom: 2rem;">
    <div style="width: 64px; height: 64px; margin: 0 auto 1rem; background: linear-gradient(135deg, #7c93c3, #9eb3d4); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(124, 147, 195, 0.2);">
      <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
      </svg>
    </div>
    <h2 style="font-size: 1.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; letter-spacing: -0.02em;">Create Account</h2>
    <p style="color: var(--text-secondary); font-size: 0.95rem;">Join us to start calculating</p>
  </div>
  
  <!-- Alert for errors -->
  <div id="errorAlert" class="alert alert-error" style="display: none;">
    <span id="errorMessage"></span>
  </div>

  <!-- Alert for success -->
  <div id="successAlert" class="alert alert-success" style="display: none;">
    <span id="successMessage"></span>
  </div>

  <form id="registrationForm" class="space-y-6">
    <div class="grid grid-cols-2" style="gap: 1rem;">
      <div>
        <label for="first_name">First Name</label>
        <input type="text" id="first_name" name="first_name" required placeholder="John">
      </div>
      <div>
        <label for="last_name">Last Name</label>
        <input type="text" id="last_name" name="last_name" required placeholder="Doe">
      </div>
    </div>

    <div>
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required placeholder="Choose a username">
    </div>

    <div>
      <label for="email">Email</label>
      <input type="email" id="email" name="email" required placeholder="your@email.com">
    </div>

    <div>
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required placeholder="At least 8 characters">
      <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Must include uppercase, lowercase, number & special character</p>
    </div>

    <div>
      <label for="confirm_password">Confirm Password</label>
      <input type="password" id="confirm_password" name="confirm_password" required placeholder="Re-enter password">
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
      Create Account
    </button>
  </form>

  <p style="margin-top: 1.5rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
    Already have an account? 
    <a href="/login" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Log in</a>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const successAlert = document.getElementById('successAlert');
    const successMessage = document.getElementById('successMessage');

    // Helper function to show error
    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.style.display = 'block';
        successAlert.style.display = 'none';
    }

    // Helper function to show success
    function showSuccess(message) {
        successMessage.textContent = message;
        successAlert.style.display = 'block';
        errorAlert.style.display = 'none';
    }

    // Helper function to validate email format
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Helper function to validate password strength
    function isValidPassword(password) {
        return password.length >= 8 && // at least 8 characters
               /[A-Z]/.test(password) && // at least one uppercase
               /[a-z]/.test(password) && // at least one lowercase
               /[0-9]/.test(password) && // at least one number
               /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password); // at least one special character
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Clear previous alerts
        errorAlert.style.display = 'none';
        successAlert.style.display = 'none';

        // Get form data
        const formData = {
            username: form.username.value.trim(),
            email: form.email.value.trim(),
            password: form.password.value,
            confirm_password: form.confirm_password.value,
            first_name: form.first_name.value.trim(),
            last_name: form.last_name.value.trim()
        };

        // Client-side validation
        if (!formData.username || formData.username.length < 3) {
            showError('Username must be at least 3 characters long');
            return;
        }

        if (!isValidEmail(formData.email)) {
            showError('Please enter a valid email address');
            return;
        }

        if (!isValidPassword(formData.password)) {
            showError('Password must be at least 8 characters long and contain uppercase, lowercase, numbers, and special characters (!@#$%^&*()_+-=[]{}\|;:,.<>?)');
            return;
        }

        if (formData.password !== formData.confirm_password) {
            showError('Passwords do not match');
            return;
        }

        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (!response.ok) {
                // Handle different error formats
                let errorMsg = 'Registration failed';
                
                // Handle FastAPI validation errors (422)
                if (response.status === 422 && data.detail && Array.isArray(data.detail)) {
                    // Extract validation error messages
                    const errors = data.detail.map(err => {
                        const field = err.loc ? err.loc[err.loc.length - 1] : 'field';
                        return `${field}: ${err.msg}`;
                    });
                    errorMsg = errors.join(', ');
                } else if (typeof data.detail === 'string') {
                    errorMsg = data.detail;
                } else if (typeof data.detail === 'object' && data.detail.message) {
                    errorMsg = data.detail.message;
                } else if (data.message) {
                    errorMsg = data.message;
                } else if (typeof data === 'string') {
                    errorMsg = data;
                }
                throw new Error(errorMsg);
            }

            // Show success message
            showSuccess('Registration successful! Redirecting to login...');

            // Redirect to login page after 2 seconds
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);

        } catch (error) {
            // Ensure we always show a string message
            let errorMsg = 'An error occurred during registration';
            if (error.message && typeof error.message === 'string') {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            }
            showError(errorMsg);
        }
    });

    // Real-time password match validation
    const passwordInput = form.password;
    const confirmPasswordInput = form.confirm_password;

    function validatePasswordMatch() {
        if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.setCustomValidity("Passwords don't match");
        } else {
            confirmPasswordInput.setCustomValidity('');
        }
    }

    passwordInput.addEventListener('change', validatePasswordMatch);
    confirmPasswordInput.addEventListener('keyup', validatePasswordMatch);
});
</script>
{% endblock %}